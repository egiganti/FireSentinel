name: Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/ci.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # ──────────────────────────────────────────────
  # Run full CI first (reuse the CI workflow)
  # ──────────────────────────────────────────────
  ci:
    name: CI Gate
    uses: ./.github/workflows/ci.yml

  # ──────────────────────────────────────────────
  # Build and deploy
  # ──────────────────────────────────────────────
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.event.inputs.environment != 'production'
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Determine deploy target
        id: target
        run: |
          echo "environment=staging" >> $GITHUB_OUTPUT
          echo "Deploying to staging..."

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            git fetch origin main
            git reset --hard origin/main
            $HOME/.local/bin/poetry install --no-interaction --no-dev
            $HOME/.local/bin/poetry run pytest tests/ -x -q
            sudo systemctl restart firesentinel

      - name: Health check
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            sleep 10
            systemctl is-active firesentinel
            echo "Staging deploy successful"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.event.inputs.environment == 'production'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}

            echo "=== Pre-deploy backup ==="
            cp data/firesentinel.db data/firesentinel.db.bak.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true

            echo "=== Pull latest ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Install deps ==="
            $HOME/.local/bin/poetry install --no-interaction --no-dev

            echo "=== Run tests ==="
            $HOME/.local/bin/poetry run pytest tests/ -x -q

            echo "=== Restart service ==="
            sudo systemctl restart firesentinel

      - name: Health check
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            sleep 15
            systemctl is-active firesentinel
            echo "Production deploy successful"

      - name: Notify on failure
        if: failure()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Deploy failed! Rolling back..."
            cd ${{ secrets.DEPLOY_PATH }}
            LATEST_BACKUP=$(ls -t data/firesentinel.db.bak.* 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ]; then
              cp "$LATEST_BACKUP" data/firesentinel.db
              echo "DB rolled back from $LATEST_BACKUP"
            fi
            git reset --hard HEAD~1
            $HOME/.local/bin/poetry install --no-interaction --no-dev
            sudo systemctl restart firesentinel
            echo "Rollback complete"
